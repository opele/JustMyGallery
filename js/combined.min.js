function isBlank(e){return!e||/^\s*$/.test(e)}function isAlphanumeric(e){return/^[a-z0-9]+$/.test(e)}function isNumber(e){return"number"==typeof e&&isFinite(e)}function capitalise(e){return e.charAt(0).toUpperCase()+e.slice(1)}function findIntersection(e,t){return e.filter(function(e){return t.indexOf(e)>-1})}function isViewingImage(){return"block"==modal.style.display}function isImgTopOutsideScreen(){if(isViewingImage()){return parseInt(modalImg[0].style.top,10)+pan.y<0}return!1}function isImgBottomOutsideScreen(){if(isViewingImage()){let e=document.documentElement.clientHeight;return parseInt(modalImg[0].style.height,10)+parseInt(modalImg[0].style.top,10)+pan.y>e}return!1}function isViewingBookmarks(){return"block"==bookmarksModalEl.style.display}function getCurrentlyViewedImgData(){if(isViewingImage())return imagesToLoad[currentImageIndex]}function arraysEqual(e,t){if(e===t)return!0;if(null==e)return null==t||!t.length;if(null==t)return null==e||!e.length;if(e.length!==t.length)return!1;for(var a=0;a<e.length;++a)if(e[a]!==t[a])return!1;return!0}function activeElementHasClass(e){return null!=document.activeElement&&null!=document.activeElement.className&&document.activeElement.className.includes(e)}function activeElementHasId(e){return null!=document.activeElement&&document.activeElement.id==e}function store(e,t){isLocalStorageAccepted()&&localStorage.setItem(e,t)}function storeCurrentImgUserData(e,t){let a=getCurrentlyViewedImgData();if(null!=a&&isLocalStorageAccepted()){let n=a.image,i=localStorage.getItem(n),o=JSON.parse(i);null!=i&&null!=o||(o=JSON.parse("{}")),null!=e&&(o.rating=e),null!=t&&(o.customTags=t),localStorage.setItem(n,JSON.stringify(o))}}function getCurrentImgUserData(){let e=getCurrentlyViewedImgData();return null!=e?getImgUserData(e.image):JSON.parse("{}")}function getImgUserData(e){let t=null;if(null!=e){let a=localStorage.getItem(e);t=JSON.parse(a)}return null==t&&(t=JSON.parse("{}")),t}var imgStartPositionYOffset=500;function GalleryColumn(e,t){var a=this;return a.gallery=e,a.index=t,a.width=0,a.height=0,a.topHeight=0,a.left=0,a.updateSize=function(){a.width=e.columnWidth},a.updatePosition=function(){a.left=e.spacing+t*e.columnWidth+t*e.spacing},a.getFirstImageBelow=function(e){let t=null;return a.gallery.forEachImage(n=>{n.column==a.index&&n.index>e&&(null==t||t.index>n.index)&&(t=n)}),t},a.getFirstImageAbove=function(e){let t=null;return a.gallery.forEachImage(n=>{n.column==a.index&&n.index<e&&(null==t||t.index<n.index)&&(t=n)}),t},a}function GalleryImage(e,t,a){var n=this;return n.gallery=e,n.data=t,n.index=a,n.column=0,n.left=0,n.top=0,n.loading=!1,n.loaded=!1,n.error=!1,n.thumbnail=$("<div>"),n.thumbnail.css({left:"0px",top:"0px"}),n.updateColumn=function(){if(n.isAddedToTop()){let e=n.gallery.getSmallestColumnTop();n.column=e.index,e.topHeight+=n.data.previewSize.h+n.gallery.spacing,n.thumbnail.attr("x-gallery-column",n.column+" "+e.topHeight)}else{let e=n.gallery.getSmallestColumnBottom();n.column=e.index,e.height+=n.data.previewSize.h+n.gallery.spacing,n.thumbnail.attr("x-gallery-position",n.index+" "+n.column+" "+e.height)}},n.updatePosition=function(e){var t=n.gallery.columns[n.column];if(n.left=t.left+n.gallery.spacing,n.top=0,n.isAddedToTop()){let e=t.getFirstImageBelow(n.index);e&&(n.top=e.top-n.data.previewSize.h-n.gallery.spacing)}else if(n.isAddedToBottom()){let e=t.getFirstImageAbove(n.index);e&&(n.top=e.top+e.data.previewSize.h+n.gallery.spacing)}if(e){var a=n.top;n.isAddedToTop()||(a=n.top+imgStartPositionYOffset),n.thumbnail.css({left:n.left+"px",top:a+"px"})}else n.thumbnail.css({left:n.left+"px",top:n.top+"px"})},n.isAddedToTop=function(){return n.gallery.baseImageIndex>n.index},n.isAddedToBottom=function(){return n.gallery.baseImageIndex<n.index},n.load=function(){if(!n.loading&&!n.loaded){n.loading=!0,n.gallery.imagesBeingLoaded++,n.thumbnail.addClass("gallery-thumb"),n.thumbnail.css({visibility:"hidden"});var e=document.createElement("img");$(e).addClass("gallery-thumb-img"),n.updatePosition(!0);var t=function(t){n.thumbnail.css({visibility:"visible"}),n.loading=!1,n.loaded=!0,n.error=t,n.gallery.imagesBeingLoaded--,setTimeout(n.updatePosition,100),n.gallery.onImageLoaded(n),t?n.gallery.imageOnErrorCallback&&n.gallery.imageOnErrorCallback({image:n,img:e}):n.gallery.imageOnLoadCallback&&n.gallery.imageOnLoadCallback({image:n,img:e})};e.onload=function(){t(!1)},e.onerror=function(){t(!0)},e.src=n.data.thumb,n.thumbnail.append(e),n.gallery.columnsContainer.append(n.thumbnail)}},n.remove=function(){n.thumbnail.remove()},n}function Gallery(e){var t=this;t.columns=[],t.columnCount=0,t.container="string"==typeof e.container?$(e.container).first():e.container,t.imageDatas=e.images,t.baseImageIndex=e.baseImageIndex||0,t.columnWidth=e.columnWidth,t.spacing=e.spacing,t.min=0,t.max=0,t.fullMin=0,t.fullMax=0,t.imagesBeingLoaded=0,t.loadInProgress=function(){return t.imagesBeingLoaded>0},t.imageOnLoadCallback=e.imageOnLoadCallback,t.imageOnErrorCallback=e.imageOnErrorCallback,t.heightCalculatedCallback=e.heightCalculatedCallback,t.columnsContainer=$(".gallery-columns"),t.columnsContainer.length?t.columnsContainer.empty():(t.columnsContainer=$("<div>"),t.columnsContainer.addClass("gallery-columns"),t.container.append(t.columnsContainer)),t.images=[];for(var a=0;a<t.imageDatas.length;++a)t.images[a]=new GalleryImage(t,t.imageDatas[a],a);t.getImage=function(e){return t.images[e]},t.forEachImage=function(e){for(var a=0;a<t.images.length;++a)e(t.images[a],a)},t.forEachImageInsertionOrder=function(e){for(var a=0;a<t.images.length;++a)t.images[a].index>=t.baseImageIndex&&e(t.images[a],a);for(a=t.images.length-1;a>=0;--a)t.images[a].index<t.baseImageIndex&&e(t.images[a],a)},t.forEachColumn=function(e){for(var a=0;a<t.columns.length;++a)e(t.columns[a],a)},t.resize=function(){var e=t.columnsContainer.width()-2*t.spacing;t.columnCount=Math.max(1,Math.floor(e/(t.columnWidth+t.spacing))),t.columns=[];for(var a=0;a<t.columnCount;++a)t.columns.push(new GalleryColumn(t,a));t.baseImageIndex>0&&t.images.length-t.baseImageIndex<t.columnCount&&(t.baseImageIndex=Math.max(0,t.images.length-t.columnCount)),t.forEachImageInsertionOrder(e=>e.updateColumn()),t.forEachColumn(e=>e.updateSize()),t.forEachColumn(e=>e.updatePosition()),t.forEachImage(e=>e.updatePosition(!1)),t.updateMinMax()},t.load=function(e,a,n){void 0===a&&(a=1);var i=e,o=e+a;if(a<0)for(var r=i;r>o;--r){var l=r;n&&(l=t.baseImageIndex+l),l<0||l>=t.images.length||t.images[l].load()}else for(r=i;r<o;++r){l=r;n&&(l=t.baseImageIndex+l),l<0||l>=t.images.length||t.images[l].load()}},t.remove=function(e,a,n){void 0===a&&(a=1);for(var i=0;i<a;++i){var o=e+i;n&&(o=t.baseImageIndex+o),t.images[o].remove()}t.resize()},t.updateMinMax=function(){t.min=0,t.max=0,t.fullMin=0,t.fullMax=0,t.forEachImage(e=>{e.loaded&&(t.min=Math.min(e.top,t.min),t.max=Math.max(e.top+e.data.previewSize.h,t.max)),t.fullMin=Math.min(e.top,t.fullMin),t.fullMax=Math.max(e.top+e.data.previewSize.h,t.fullMax)}),t.applyMinMax()},t.getSmallestColumnBottom=function(){var e=t.columns[0];return t.forEachColumn(t=>{t.height<e.height&&(e=t)}),e},t.getSmallestColumnTop=function(){var e=t.columns[0];return t.forEachColumn(t=>{t.topHeight<e.topHeight&&(e=t)}),e},t.onImageLoaded=function(e){t.min=Math.min(e.top,t.min),t.max=Math.max(e.top+e.data.previewSize.h,t.max),t.fullMin=Math.min(e.top,t.fullMin),t.fullMax=Math.max(e.top+e.data.previewSize.h,t.fullMax),t.applyMinMax()},t.applyMinMax=function(){var e=Math.abs(t.max-t.min),a=Math.abs(t.fullMax-t.fullMin)+imgStartPositionYOffset;t.columnsContainer.css({height:e+"px"}),t.min<0?t.columnsContainer.css({transform:"translateY("+-t.min+"px)"}):t.columnsContainer.css({transform:"translateY(0px)"}),t.heightCalculatedCallback&&t.heightCalculatedCallback({h:a,min:t.fullMin,max:t.fullMax})},t.resize();var n=null;return window.addEventListener("resize",()=>{n&&clearTimeout(n),n=setTimeout(()=>{n=null,t.resize()},400)}),t}var currentFromFilterDate,currentToFilterDate,currentFilterTags,currentFilterCategory,gallery,imagesToLoad,modal,next,previous,captionText,ratingEl,predefinedTagsEl,userDefinedTagsEl,modalNavCurrentEl,modalNavMaxEl,addBookmarkEl,bookmarksModalEl,bookmarksListEl,observer,customTagsDirty=!1,sortByRating=!1,sortByDateAsc=!1,sortByDateDesc=!1,sortByName=!1,filterByNameEnabled=!1,filterByDateEnabled=!1,filterByTagsEnabled=!1,filterByCategoryEnabled=!1,categoriesAndTags=!0,nameFilterFunc=function(e){return!0},tagsFilterFunc=function(e){return!0},categoryFilterFunc=function(e){return!0},dateRangeFilterFunc=function(e){return!0},filterFunction=function(e){return e.filter(function(e){return nameFilterFunc(e)&&(!filterByTagsEnabled||!filterByCategoryEnabled||categoriesAndTags&&tagsFilterFunc(e)&&categoryFilterFunc(e)||!categoriesAndTags&&(tagsFilterFunc(e)||categoryFilterFunc(e)))&&(filterByTagsEnabled&&filterByCategoryEnabled||tagsFilterFunc(e)&&categoryFilterFunc(e))&&dateRangeFilterFunc(e)})},imgIdxOffset=0,chunkSize=15,scrolledToEnd=!1,lastChunkLoaded=!0,minDelayLoadingNextChunkSec=1,minDelayLoadingNextChunkPassed=!0,currentImageIndex=0,scaleUpImageHeight=!0,scaleUpImageWidth=!0,scaleDownImageWidth=!0,scaleDownImageHeight=!0,optimalWidthRatio=.7,optimalHeightRatio=.95,scaleHeightRatioThreshold=3,scaleWidthRatioThreshold=3,maxScale=2,preloadedImages=[],numberOfPrevImgsToPreload=1,numberOfNextImgsToPreload=2;function loadImages(e){imgIdxOffset=e||0,scrolledToEnd=!1,imagesToLoad=imgData,"function"==typeof filterFunction&&(imagesToLoad=filterFunction(imagesToLoad)),updateImgCountDisplay(),imagesToLoad.sort(sortImages),topImageId=0,bottomImageId=0;var t=!0;if(lastChunkLoaded=!0,gallery=new Gallery({container:"#gallery-images-container",images:imagesToLoad,baseImageIndex:imgIdxOffset,columnWidth:230,spacing:10,imageOnLoadCallback:function(e){t&&(0!=imgIdxOffset&&$("#loadPreviousBtn").show(),t=!1),e.image.thumbnail.get(0).onclick=function(){openImgDetailsView(e.image.index)},gallery.loadInProgress()||(topImageId+imgIdxOffset>0&&$("#loadPreviousBtn").show(),lastChunkLoaded=!0,tryLoadNextChunk())},heightCalculatedCallback:function(e){$(document.body).height(e.h)}}),registerIntersectionCallback(),0===imgIdxOffset)"scrollRestoration"in history&&(history.scrollRestoration="manual"),window.scrollTo(0,0),$("#loadPreviousBtn").hide();else{let e=gallery.columnsContainer.offset().top;window.scrollTo(0,e)}imgIdxOffset=gallery.baseImageIndex}function registerIntersectionCallback(){(observer=new IntersectionObserver((e,t)=>{e.forEach(e=>{e.isIntersecting?(scrolledToEnd=!0,tryLoadNextChunk()):scrolledToEnd=!1})})).observe($("#sentinel").get(0))}$(function(){refreshSelectableTags(),refreshSelectableCategories()}),$(function(){modal=document.getElementById("imageModal"),captionText=document.getElementById("caption"),ratingEl=document.getElementById("rating"),predefinedTagsEl=document.getElementById("predefinedTags"),userDefinedTagsEl=document.getElementById("myTags"),modalNavCurrentEl=document.getElementById("modalNavCurrent"),modalNavMaxEl=document.getElementById("modalNavMax"),addBookmarkEl=document.getElementById("addBookmark"),bookmarksModalEl=document.getElementById("bookmarksModal"),bookmarksListEl=document.getElementById("bookmarksList"),initSearchSidebar(),initSettingsSidebar(),loadImages()});var topImageId=0,bottomImageId=0;function tryLoadNextChunk(){scrolledToEnd&&lastChunkLoaded&&minDelayLoadingNextChunkPassed&&(lastChunkLoaded=!1,gallery.load(bottomImageId,chunkSize,!0),bottomImageId+=chunkSize,minDelayLoadingNextChunkPassed=!1,setTimeout(tryLoadNextChunkFromTimer,1e3*minDelayLoadingNextChunkSec))}function tryLoadNextChunkFromTimer(){minDelayLoadingNextChunkPassed=!0,tryLoadNextChunk()}function tryLoadPreviousChunk(){$("#loadPreviousBtn").hide(),gallery.load(topImageId,-chunkSize,!0),topImageId-=chunkSize}function updateImgCountDisplay(){$("#filteredImgNumberInfo").html(imagesToLoad.length+" images to show.")}function sortImages(e,t){var a=0;if(sortByRating&&(a=sortImagesByRating(e,t)),0==a)if(sortByDateAsc){if(e.timestamp&&t.timestamp)return e.timestamp-t.timestamp}else if(sortByDateDesc){if(e.timestamp&&t.timestamp)return t.timestamp-e.timestamp}else if(sortByName&&e.title&&t.title){var n=e.title.toLowerCase(),i=t.title.toLowerCase();if(n<i)return-1;if(n>i)return 1}return a}function sortImagesByRating(e,t){var a=JSON.parse(localStorage.getItem(e.image)),n=a&&a.rating,i=JSON.parse(localStorage.getItem(t.image)),o=i&&i.rating;return n||o?!n&&o?1:n&&!o?-1:a.rating>i.rating?-1:a.rating<i.rating?1:0:0}function toggleSortByDateAsc(){sortByDateAsc=!sortByDateAsc,sortByDateDesc=!1,sortByName=!1,refreshSortingUi(),persistSorting(),loadImages()}function toggleSortByDateDesc(){sortByDateDesc=!sortByDateDesc,sortByDateAsc=!1,sortByName=!1,refreshSortingUi(),persistSorting(),loadImages()}function toggleSortByName(){sortByName=!sortByName,sortByDateDesc=!1,sortByDateAsc=!1,refreshSortingUi(),persistSorting(),loadImages()}function toggleSortByRating(){sortByRating=!sortByRating,$("#sortByRatingSwitch").prop("checked",sortByRating),persistSorting(),loadImages()}function refreshSortingUi(){$("#sortByDateAscSwitch").prop("checked",sortByDateAsc),$("#sortByDateDescSwitch").prop("checked",sortByDateDesc),$("#sortByNameSwitch").prop("checked",sortByName),$("#sortByRatingSwitch").prop("checked",sortByRating)}function persistSorting(){store("sortByRating",sortByRating),store("sortByDateAsc",sortByDateAsc),store("sortByDateDesc",sortByDateDesc),store("sortByName",sortByName)}$(function(){$(window).keydown(function(e){isViewingImage()&&!isEditingModalComponent()?(processKeyEvtForRating(e),"ArrowLeft"==e.key?navigateToPrevious(null):"ArrowRight"==e.key?navigateToNext(null):"Escape"==e.key?closeImageView(e,!0):"ArrowUp"==e.key?modal.scrollTop-=20:"ArrowDown"==e.key&&(modal.scrollTop+=20)):isViewingImage()||("Escape"==e.key?isViewingBookmarks()?closeBookmarksModal():closeSidebar():"1"!=e.key||isSidebarVisible()?"2"!=e.key||isSidebarVisible()?"3"!=e.key||isSidebarVisible()||openSettingsSidebar():openBookmarksModal():openSearchSidebar())}),$(window).on("mousewheel DOMMouseScroll",function(e){isViewingImage()&&!isEditingModalComponent()&&(e.shiftKey?resizeImage(e):moveImageY(e))})}),$(function(){$("#sortByDateAscButton").on("click",function(e){toggleSortByDateAsc()}),$("#sortByDateAscButton").on("keydown",function(e){"Enter"==event.key&&(event.preventDefault(),toggleSortByDateAsc())}),$("#sortByDateAscSwitch").on("click",function(e){return!1}),$("#sortByDateDescButton").on("click",function(e){toggleSortByDateDesc()}),$("#sortByDateDescButton").on("keydown",function(e){"Enter"==event.key&&(event.preventDefault(),toggleSortByDateDesc())}),$("#sortByDateDescSwitch").on("click",function(e){return!1}),$("#sortByNameButton").on("click",function(e){toggleSortByName()}),$("#sortByNameButton").on("keydown",function(e){"Enter"==event.key&&(event.preventDefault(),toggleSortByName())}),$("#sortByNameSwitch").on("click",function(e){return!1}),$("#sortByRatingButton").on("click",function(e){toggleSortByRating()}),$("#sortByRatingButton").on("keydown",function(e){"Enter"==event.key&&(event.preventDefault(),toggleSortByRating())}),$("#sortByRatingSwitch").on("click",function(e){return!1})});var myTagsPrefix="&nbsp;&nbsp;&nbsp;&nbsp;My Tags:&nbsp;",myTagEmptyHtml='<span class="my-tag" contenteditable=true>&nbsp;&nbsp;&nbsp;&nbsp</span>';function displayTags(e){var t=$(predefinedTagsEl);if(t.html(""),e&&t.html("&nbsp;&nbsp;&nbsp;&nbsp;Tags: "+e.replaceAll(",",", ")),isLocalStorageAccepted()){$(userDefinedTagsEl).html(myTagsPrefix);let e=getCurrentImgUserData();e.customTags&&e.customTags.length>0&&e.customTags.split(",").forEach(e=>{appendNewCustomTag(myTagEmptyHtml).html(e+",&nbsp;")});appendNewCustomTag(myTagEmptyHtml)}}function myTagKeypress(e){if("Enter"!=e.key)return isAlphanumeric(e.key)||"-"==e.key||"_"==e.key;e.preventDefault(),confirmedMyTag(e)}function confirmedMyTag(e){let t=e.target.textContent.trim();t.length&&0!=t.length?e.target.innerHtml=t.replace(/&nbsp;|\s/g,"")+"&nbsp":e.target.innerHtml="&nbsp;&nbsp;&nbsp;&nbsp;",e.target.blur(),addEmptyTagToEditIfRequired(),persistCustomTags($(e.target.parentElement))}function persistCustomTags(e){if(null!=e){let t=null;e.children(".my-tag").each(function(e){let a=$(this).html();null!=a&&a.length&&(null==t?t=a:t+=a)}),(t=t.replace(/&nbsp;|\s/g,"")).endsWith(",")&&(t=t.slice(0,-1)),storeCurrentImgUserData(null,t),customTagsDirty=!0}}function addEmptyTagToEditIfRequired(){let e=$(userDefinedTagsEl).find(".my-tag").last(),t=null==e||!e.length;(t||e.text().trim().length>0)&&(t||e.text().trim().endsWith(",")||e.html(e.text().trim().replace(/&nbsp;|\s/g,"")+",&nbsp;"),appendNewCustomTag(myTagEmptyHtml).focus())}function appendNewCustomTag(e){let t=$(userDefinedTagsEl).append(e).find(".my-tag").last();return t.keypress(myTagKeypress),t.keydown(myTagKeydown),t.blur(confirmedMyTag),t}function myTagKeydown(e){if("Backspace"==e.key){if(window.getSelection){var t=window.getSelection().toString();if(t.length>0&&t.trim().length>0&&t.trim()==e.target.textContent.trim().replace(",","")){e.preventDefault();let t=e.target.parentElement;$(e.target).remove(),persistCustomTags($(t))}}}else"ArrowRight"!=e.key&&"ArrowLeft"!=e.key||e.stopPropagation()}function isEditingTags(){return activeElementHasClass("my-tag")}function filterByName(){var e=$("#inputNameFilter").val();filterByNameEnabled=!isBlank(e),applyFilterByName(e),store("filterByNameEnabled",filterByNameEnabled),store("currentFilterByName",e),loadImages()}function applyFilterByName(e){nameFilterFunc=filterByNameEnabled?function(t){return t.title&&t.title.toLowerCase().includes(e.toLowerCase())}:function(e){return!0},displayAsActive(filterByNameEnabled,$("#nameFilterContainer").get(0))}function filterByDateRange(){filterFrom=document.getElementById("inputDateFromFilter").valueAsNumber,filterTo=document.getElementById("inputDateToFilter").valueAsNumber,(filterFrom===currentFromFilterDate||isNaN(filterFrom)&&isNaN(currentFromFilterDate))&&(filterTo===currentToFilterDate||isNaN(filterTo)&&isNaN(currentToFilterDate))||(currentFromFilterDate=filterFrom,currentToFilterDate=filterTo,filterByDateEnabled=!((isBlank(filterFrom)||isNaN(filterFrom))&&(isBlank(filterTo)||isNaN(filterTo))),applyFilterByDateRange(),store("filterByDateEnabled",filterByDateEnabled),store("currentFromFilterDate",currentFromFilterDate),store("currentToFilterDate",currentToFilterDate),loadImages())}function applyFilterByDateRange(){var e=currentFromFilterDate,t=currentToFilterDate;filterByDateEnabled?((isBlank(e)||isNaN(e))&&(e=-1),(isBlank(t)||isNaN(t))&&(t=Number.MAX_VALUE),dateRangeFilterFunc=function(a){return a.timestamp&&a.timestamp>=e&&a.timestamp<=t}):dateRangeFilterFunc=function(e){return!0},displayAsActive(filterByDateEnabled,$("#dateFilterContainer").get(0))}function filterFromDateChanged(){var e=document.getElementById("inputDateFromFilter").valueAsNumber;(isBlank(e)||isNaN(e))&&filterByDateRange()}function filterToDateChanged(){var e=document.getElementById("inputDateToFilter").valueAsNumber;(isBlank(e)||isNaN(e))&&filterByDateRange()}function filterByTags(){var e=$("#tagsFilter").val();arraysEqual(e,currentFilterTags)||(currentFilterTags=e,filterByTagsEnabled=e&&e.length>0,applyFilterByTags(),store("filterByTagsEnabled",filterByTagsEnabled),store("currentFilterTags",currentFilterTags),loadImages())}function applyFilterByTags(){tagsFilterFunc=filterByTagsEnabled?function(e){let t=e.tags,a=getImgUserData(e.image).customTags;return a&&a.length&&(t&&t.length?t+=","+a:t=a),t.length&&findIntersection(t.split(","),currentFilterTags).length>0}:function(e){return!0},displayAsActive(filterByTagsEnabled,$("#tagsFilterContainer").get(0))}function filterByCategory(){var e=$("#categoryFilter").val();e!==currentFilterCategory&&(currentFilterCategory=e,filterByCategoryEnabled=!isBlank(e),applyFilterByCategory(),store("filterByCategoryEnabled",filterByCategoryEnabled),store("currentFilterCategory",currentFilterCategory),loadImages())}function applyFilterByCategory(){categoryFilterFunc=filterByCategoryEnabled?function(e){return e.categories&&e.categories.split(",").includes(currentFilterCategory)}:function(e){return!0},displayAsActive(filterByCategoryEnabled,$("#categoryFilterContainer").get(0))}function toggleTagsAndCategoryFilter(){categoriesAndTags=!categoriesAndTags,applyTagsAndCategoryFilter(),store("categoriesAndTags",categoriesAndTags),filterByCategoryEnabled&&filterByTagsEnabled&&loadImages()}function applyTagsAndCategoryFilter(){categoriesAndTags?$("#toggleTagsAndCategoryFilterBtn").html("Tags AND Category"):$("#toggleTagsAndCategoryFilterBtn").html("Tags OR Category")}function openSearchSidebar(){$(".sidebar-open-button").hide(),$("#settingsSidebar").hide(),$("#searchAndFilterSidebar").show(),document.getElementById("sidebar-container").style.left="0px"}function closeSidebar(){document.getElementById("sidebar-container").style.left="-250px",$(".sidebar-open-button").show(500)}function isSidebarVisible(){return $("#sidebar-container").position().left>=0}function displayAsActive(e,t){e?(t.classList.remove("bg-dark"),t.classList.add("active")):(t.classList.remove("active"),t.classList.add("bg-dark"))}function initSearchSidebar(){var e=null;isLocalStorageAccepted()&&(sortByRating="true"==localStorage.getItem("sortByRating"),sortByDateAsc="true"==localStorage.getItem("sortByDateAsc"),sortByDateDesc="true"==localStorage.getItem("sortByDateDesc"),sortByName="true"==localStorage.getItem("sortByName"),filterByNameEnabled="true"==localStorage.getItem("filterByNameEnabled"),e=localStorage.getItem("currentFilterByName"),filterByDateEnabled="true"==localStorage.getItem("filterByDateEnabled"),currentFromFilterDate=parseInt(localStorage.getItem("currentFromFilterDate")),currentToFilterDate=parseInt(localStorage.getItem("currentToFilterDate")),filterByTagsEnabled="true"==localStorage.getItem("filterByTagsEnabled"),localStorage.getItem("currentFilterTags")&&(currentFilterTags=localStorage.getItem("currentFilterTags").split(",")),filterByCategoryEnabled="true"==localStorage.getItem("filterByCategoryEnabled"),currentFilterCategory=localStorage.getItem("currentFilterCategory"),categoriesAndTags="true"==localStorage.getItem("categoriesAndTags")),refreshSortingUi(),$("#inputNameFilter").val(e),applyFilterByName(e),document.getElementById("inputDateFromFilter").valueAsNumber=currentFromFilterDate,document.getElementById("inputDateToFilter").valueAsNumber=currentToFilterDate,applyFilterByDateRange(),null!=currentFilterTags&&currentFilterTags.length>0&&$("#tagsFilter").selectpicker("val",currentFilterTags),applyFilterByTags(),isBlank(currentFilterCategory)||$("#categoryFilter").selectpicker("val",currentFilterCategory),applyFilterByCategory(),applyTagsAndCategoryFilter()}function toggleDisplaySidebarElementInForeground(e,t){$("#sidebar-container > ul > div").each(function(a){t?e.is($(this))||$(this).css("z-index",0):$(this).css("z-index",2)})}function refreshSelectableTags(){customTagsDirty=!1;var e=new Set;imgData.forEach(function(t){t.tags&&t.tags.split(",").forEach(t=>e.add(t)),item=JSON.parse(localStorage.getItem(t.image)),null!=item&&item.customTags&&item.customTags.length&&item.customTags.split(",").forEach(t=>e.add(t))}),$("#tagsFilter").empty(),e.forEach(function(e){$("#tagsFilter").append('<option value="'+e+'">'+e+"</option>")}),$("#tagsFilter").selectpicker("refresh"),filterByTagsEnabled&&null!=currentFilterTags&&currentFilterTags.length>0&&(null!=(currentFilterTags=findIntersection(currentFilterTags,Array.from(e)))&&currentFilterTags.length>0?$("#tagsFilter").selectpicker("val",currentFilterTags):($("#tagsFilter").selectpicker("val",null),store("filterByTagsEnabled",filterByTagsEnabled=!1),applyFilterByTags()),store("currentFilterTags",currentFilterTags),1!=imagesToLoad.length&&1!=gallery.images.length||filterByTagsEnabled||loadImages()),$("#tagsFilter").selectpicker("refresh")}function refreshSelectableCategories(){var e=new Set;imgData.forEach(function(t){t.categories&&t.categories.split(",").forEach(t=>e.add(t))}),$("#categoryFilter").empty(),e.forEach(function(e){$("#categoryFilter").append('<option value="'+e+'">'+capitalise(e)+"</option>")}),$("#categoryFilter").selectpicker("refresh")}function openSettingsSidebar(){$(".sidebar-open-button").hide(),$("#searchAndFilterSidebar").hide(),$("#settingsSidebar").show(),document.getElementById("sidebar-container").style.left="0px"}function initSettingsSidebar(){isLocalStorageAccepted()&&loadSettingsFromStorage(),refreshSettingsUi()}function updateOptimalWidthRatio(){let e=Number(document.getElementById("imgWindowWidthRatio").value);isNumber(e)||(console.log("Error: Invalid input for imgWindowWidthRatio: "+e),document.getElementById("imgWindowWidthRatio").value=.75,e=.75),optimalWidthRatio=e,persistSettings()}function updateOptimalHeightRatio(){let e=Number(document.getElementById("imgWindowHeightRatio").value);isNumber(e)||(console.log("Error: Invalid input for imgWindowHeightRatio: "+e),document.getElementById("imgWindowHeightRatio").value=.95,e=.95),optimalHeightRatio=e,persistSettings()}function updateWidthRatioThreshold(){let e=Number(document.getElementById("imgWidthRatioThreshold").value);isNumber(e)||(console.log("Error: Invalid input for imgWidthRatioThreshold: "+e),document.getElementById("imgWidthRatioThreshold").value=3,e=3),scaleWidthRatioThreshold=e,persistSettings()}function updateHeightRatioThreshold(){let e=Number(document.getElementById("imgHeightRatioThreshold").value);isNumber(e)||(console.log("Error: Invalid input for imgHeightRatioThreshold: "+e),document.getElementById("imgHeightRatioThreshold").value=3,e=3),scaleHeightRatioThreshold=e,persistSettings()}function toggleScaleUpImageWidth(){scaleUpImageWidth=!scaleUpImageWidth,refreshSettingsUi(),persistSettings()}function toggleScaleDownImageWidth(){scaleDownImageWidth=!scaleDownImageWidth,refreshSettingsUi(),persistSettings()}function toggleScaleUpImageHeight(){scaleUpImageHeight=!scaleUpImageHeight,refreshSettingsUi(),persistSettings()}function toggleScaleDownImageHeight(){scaleDownImageHeight=!scaleDownImageHeight,refreshSettingsUi(),persistSettings()}function refreshSettingsUi(){document.getElementById("imgWindowWidthRatio").value=optimalWidthRatio,document.getElementById("imgWidthRatioThreshold").value=scaleWidthRatioThreshold,$("#scaleUpImgWidthSwitch").prop("checked",scaleUpImageWidth),$("#scaleDownImgWidthSwitch").prop("checked",scaleDownImageWidth),document.getElementById("imgWindowHeightRatio").value=optimalHeightRatio,document.getElementById("imgHeightRatioThreshold").value=scaleHeightRatioThreshold,$("#scaleUpImgHeightSwitch").prop("checked",scaleUpImageHeight),$("#scaleDownImgHeightSwitch").prop("checked",scaleDownImageHeight)}function persistSettings(){store("optimalWidthRatio",optimalWidthRatio),store("scaleWidthRatioThreshold",scaleWidthRatioThreshold),store("scaleUpImageWidth",scaleUpImageWidth),store("scaleDownImageWidth",scaleDownImageWidth),store("optimalHeightRatio",optimalHeightRatio),store("scaleHeightRatioThreshold",scaleHeightRatioThreshold),store("scaleUpImageHeight",scaleUpImageHeight),store("scaleDownImageHeight",scaleDownImageHeight)}function loadSettingsFromStorage(){let e=Number(localStorage.getItem("optimalWidthRatio"));isNumber(e)&&e>0&&(optimalWidthRatio=e),isNumber(e=Number(localStorage.getItem("scaleWidthRatioThreshold")))&&e>0&&(scaleWidthRatioThreshold=e),null!==localStorage.getItem("scaleUpImageWidth")&&(scaleUpImageWidth="true"==localStorage.getItem("scaleUpImageWidth")),null!==localStorage.getItem("scaleDownImageWidth")&&(scaleDownImageWidth="true"==localStorage.getItem("scaleDownImageWidth")),isNumber(e=Number(localStorage.getItem("optimalHeightRatio")))&&e>0&&(optimalHeightRatio=e),isNumber(e=Number(localStorage.getItem("scaleHeightRatioThreshold")))&&e>0&&(scaleHeightRatioThreshold=e),null!==localStorage.getItem("scaleUpImageHeight")&&(scaleUpImageHeight="true"==localStorage.getItem("scaleUpImageHeight")),null!==localStorage.getItem("scaleDownImageHeight")&&(scaleDownImageHeight="true"==localStorage.getItem("scaleDownImageHeight"))}function displayRating(e){var t=$(ratingEl);t.on("keydown keyup keyleft keyright","input",function(e){e.preventDefault()});var a=JSON.parse(localStorage.getItem(e));refreshRating(t,null==a?null:a.rating)}function rateImage(e,t){e&&e.stopPropagation(),isLocalStorageAccepted()?(storeCurrentImgUserData(t,null),refreshRating($(e.target.parentElement),t)):alert("Unable to remember new rating without permission to use local browser storage.")}function refreshRating(e,t){e.children("span").each(function(e){var a=t&&e<t;$(this).get(0).className=a?"fa fa-star checked":"fa fa-star unchecked"})}function processKeyEvtForRating(e){var t=$(ratingEl);"1"==e.key?t.children("span").get(0).click():"2"==e.key?t.children("span").get(1).click():"3"==e.key?t.children("span").get(2).click():"4"==e.key?t.children("span").get(3).click():"5"==e.key&&t.children("span").get(4).click()}let currSelectedImg;$("#inputNameFilter").keypress(function(e){"Enter"==e.key&&(e.preventDefault(),filterByName(),$('[data-toggle="tooltip"]').tooltip("hide"))}),$(function(){$(".bs-select-clear-selected").click(function(){currentFilterCategory=null,categoryFilterFunc=function(e){return!0},displayAsActive(filterByCategoryEnabled=!1,$("#categoryFilterContainer").get(0)),store("filterByCategoryEnabled",filterByCategoryEnabled),store("currentFilterCategory",currentFilterCategory),loadImages()})}),$(function(){$(".close-sidebar-btn").keydown(function(e){"Enter"==e.key&&closeSidebar()})}),$(function(){$("#tagsFilter").on("show.bs.select",function(e){toggleDisplaySidebarElementInForeground($("#tagsFilterContainer"),!0)}),$("#tagsFilter").on("hide.bs.select",function(e){toggleDisplaySidebarElementInForeground($("#tagsFilterContainer"),!1),filterByTags()}),$("#tagsFilter + button.btn.dropdown-toggle").keydown(function(e){var t=$("#tagsFilter");t.parent().hasClass("show")?"ArrowLeft"==e.key&&t.selectpicker("toggle"):"Backspace"==e.key&&(t.selectpicker("deselectAll"),filterByTags())})}),$(function(){$("#categoryFilter").on("show.bs.select",function(e){toggleDisplaySidebarElementInForeground($("#categoryFilterContainer"),!0)}),$("#categoryFilter").on("hide.bs.select",function(e){toggleDisplaySidebarElementInForeground($("#categoryFilterContainer"),!1),filterByCategory()}),$("#categoryFilter + button.btn.dropdown-toggle").keydown(function(e){var t=$("#categoryFilter");t.parent().hasClass("show")?"ArrowLeft"==e.key&&t.selectpicker("toggle"):"Backspace"==e.key&&t.val().length>0&&$(".bs-select-clear-selected").click()})}),$(function(){$("#scaleUpImgWidthButton").on("click",function(e){toggleScaleUpImageWidth()}),$("#scaleUpImgWidthButton").on("keydown",function(e){"Enter"==event.key&&(event.preventDefault(),toggleScaleUpImageWidth())}),$("#scaleUpImgWidthSwitch").on("click",function(e){return!1}),$("#scaleDownImgWidthButton").on("click",function(e){toggleScaleDownImageWidth()}),$("#scaleDownImgWidthButton").on("keydown",function(e){"Enter"==event.key&&(event.preventDefault(),toggleScaleDownImageWidth())}),$("#scaleDownImgWidthSwitch").on("click",function(e){return!1}),$("#scaleUpImgHeightButton").on("click",function(e){toggleScaleUpImageHeight()}),$("#scaleUpImgHeightButton").on("keydown",function(e){"Enter"==event.key&&(event.preventDefault(),toggleScaleUpImageHeight())}),$("#scaleUpImgHeightSwitch").on("click",function(e){return!1}),$("#scaleDownImgHeightButton").on("click",function(e){toggleScaleDownImageHeight()}),$("#scaleDownImgHeightButton").on("keydown",function(e){"Enter"==event.key&&(event.preventDefault(),toggleScaleDownImageHeight())}),$("#scaleDownImgHeightSwitch").on("click",function(e){return!1})}),$(function(){var e=$("#imageSizeRange");e.on("input change",function(){applyScaleToImg(e.val(),modalImg[0],currSelectedImg.size)})});let modalImg,isPanning=!1;function openImgDetailsView(e){if(modalImg=$("#modalImg"),isPanning=!1,resetPan(),!(isNumber(e)&&Number.isInteger(e)&&e>=0&&e<=imagesToLoad.length))return void console.log("Warning: ignoring invalid image index: "+e);let t=$("#modalPanner");$("#imageSizeRangeContainer").show(),$(".loader").show(),$(".sidebar-open-button").hide(),$("body").css("overflow","hidden");let a=currSelectedImg=imagesToLoad[e];currentImageIndex=e,canNavigateToNext()?$(".next").show():$(".next").hide(),canNavigateToPrevious()?$(".previous").show():$(".previous").hide(),modalImg[0].remove(),t.append('<img class="modal-content" id="modalImg" draggable="false"></img>'),applyImageSizeRange((modalImg=$("#modalImg"))[0],a.size),installPanning();var n=function(e){$(".loader").hide(),preloadImages()};modalImg.on("load",n),modalImg.attr("src",a.image),modalImg[0].complete&&n(),captionText.innerHTML=a.title,displayRating(a.image),updateModalNav(),updateBookmarkOnImageDetailView(a.image),modal.style.display="block",displayTags(a.tags)}var panStart={x:0,y:0},pan={x:0,y:0};function resetPan(){panStart={x:0,y:0},pan={x:0,y:0},modalImg.css({transform:""})}function installPanning(){modalImg.on("mousemove",e=>{if(!isPanning)return;let t=e.pageX-panStart.x,a=e.pageY-panStart.y;pan.x+=t,pan.y+=a,panStart.x=e.pageX,panStart.y=e.pageY,applyPanning()}),modalImg.on("mousedown",e=>{event.preventDefault(),isPanning=!0,$(".modal-content").css({cursor:"grabbing"}),panStart.x=e.pageX,panStart.y=e.pageY}),modalImg.on("mouseup",e=>{isPanning=!1,$(".modal-content").css({cursor:"grab"})})}function applyPanning(){modalImg.css({transform:"translate("+pan.x+"px,"+pan.y+"px)"})}function canNavigateToPrevious(){return currentImageIndex>0}function navigateToPrevious(e){e&&e.stopPropagation(),canNavigateToPrevious()&&openImgDetailsView(currentImageIndex-1)}function canNavigateToNext(){return currentImageIndex<imagesToLoad.length-1}function navigateToNext(e){e&&e.stopPropagation(),canNavigateToNext()&&openImgDetailsView(currentImageIndex+1)}function updateModalNav(){modalNavCurrentEl.value=currentImageIndex+1,modalNavMaxEl.textContent=imagesToLoad.length}function applyImageSizeRange(e,t){let a=e;t||(t={w:a.naturalWidth,h:a.naturalHeight});let n=document.documentElement.clientWidth,i=optimalWidthRatio*n/t.w,o=i<1,r=scaleUpImageWidth&&!o,l=scaleDownImageWidth&&o,s=r||l,g=document.documentElement.clientHeight,c=optimalHeightRatio*g/t.h,m=c<1,d=scaleUpImageHeight&&!m,u=scaleDownImageHeight&&m,p=d||u,f=!1,h=!1,y=!1;if(u||l)if(c<i){let e=t.h;l&&(e*=i),f=scaleHeightRatioThreshold>e/g,y=!0}else{let e=t.w;u&&(e*=c),h=scaleWidthRatioThreshold>e/n,optimalScalingApplies=h}else c>i?(f=d,y=!0):h=r;if(!f&&!f)if(y){if(s){let e=t.w;h=scaleWidthRatioThreshold>e/n}}else if(p){let e=t.h;f=scaleHeightRatioThreshold>e/g}let I=1;f?I=c:h&&(I=i),I>maxScale&&(I=maxScale);var b=$("#imageSizeRange");b.attr("max",maxScale),b.css("display","block"),b.val(I),applyScaleToImg(b.val(),a,t)}function applyScaleToImg(e,t,a){let n=a.w*e,i=a.h*e,o=(parseInt(t.style.width,10),i/parseInt(t.style.height,10));t.style.width=n+"px",t.style.height=i+"px";let r=document.documentElement.clientHeight;if(i<r){let e=r/2-i/2;t.style.top=e+"px"}else t.style.top="0px";o<1&&(pan.y*=o,applyPanning())}function resizeImage(e){var t=$("#imageSizeRange");if(t.length){var a=e.originalEvent.wheelDelta/120||-e.originalEvent.detail/3;t.val(t.val()-.04*a),t.change()}}function moveImageY(e){let t=e.originalEvent.wheelDelta/120||-e.originalEvent.detail/3,a=t>0;(a&&isImgTopOutsideScreen()||!a&&isImgBottomOutsideScreen())&&(pan.y+=50*t,applyPanning())}function preloadImages(){preloadNextImages(),preloadPreviousImages()}function preloadNextImages(){for(let e=0;e<numberOfNextImgsToPreload;e++){let t=currentImageIndex+1+e;if(t>=imagesToLoad.length)break;preloadedImages[e]=new Image,preloadedImages[e].src=imagesToLoad[t].image}}function preloadPreviousImages(){preloadedImages.length>30&&(preloadedImages=[]);let e=preloadedImages.length;for(let t=0;t<numberOfPrevImgsToPreload;t++){let a=currentImageIndex-1-t;if(a<0)break;preloadedImages[e+t]=new Image,preloadedImages[e+t].src=imagesToLoad[a].image}}function closeImageView(e,t){"modalImg"!==e.target.id&&(!t&&isEditingModalComponent()||($("#imageSizeRangeContainer").hide(),modal.style.display="none",hideImageSizeRange(),customTagsDirty&&(refreshSelectableTags(),maybeRemovePreviewImg()),isSidebarVisible()||$(".sidebar-open-button").show(),$("body").css("overflow","auto")))}function isEditingModalComponent(){return isEditingNav()||isEditingTags()}function isEditingNav(){return activeElementHasId("modalNavCurrent")}function maybeRemovePreviewImg(){try{let e=imagesToLoad[currentImageIndex];e&&gallery.images[currentImageIndex]&&e.image===gallery.images[currentImageIndex].data.image&&(filterFunction([e]).length||(gallery.remove(currentImageIndex),imagesToLoad.splice(currentImageIndex,1),updateImgCountDisplay()))}catch(e){console.error("Failed to remove preview image after deleting a tag:"),console.error(e,e.stack)}}function hideImageSizeRange(){var e=$("#imageSizeRange");e.length&&e.css("display","none")}function syncGalleryWithImg(e){e.stopPropagation(),loadImages(currentImageIndex)}function openBookmarksModal(){$("body").css("overflow","hidden"),loadBookmarksView(),$(bookmarksModalEl).show()}function closeBookmarksModal(){$("body").css("overflow","auto"),$(bookmarksModalEl).hide()}function loadBookmarksView(){let e=Array.from(bookmarksListEl.childNodes).filter(e=>"bookmarks-column"==e.className),t=getBookmarks();e.forEach(e=>e.innerHTML="");let a=[],n=0;t.forEach(t=>{let i=imagesToLoad.findIndex(e=>e.image==t);i>=0?$(e[n++%e.length]).append('<img src="'+imagesToLoad[i].thumb+'" style="width:100%" onclick="loadBookmark(event, '+i+')">'):a.push(t)}),a.forEach(t=>{let a=imgData.findIndex(e=>e.image==t);a>=0?$(e[n++%e.length]).append('<div class="bookmark-container-filtered-out"><img src="'+imgData[a].thumb+'" class="bookmark-filtered-out" style="width:100%"> <div class="centered-text">Filtered Out</div></div>'):console.log("Info: bookmarked image does not exist anymore (image name or path changed) and likely can be removed from your browsers local storage: "+t)})}function loadBookmark(e,t){e.stopPropagation(),closeBookmarksModal(),openImgDetailsView(t)}function updateBookmarkOnImageDetailView(e){null!=getBookmarks().find(t=>t==e)?($(addBookmarkEl).removeClass("fa-bookmark-o"),$(addBookmarkEl).addClass("fa-bookmark")):($(addBookmarkEl).removeClass("fa-bookmark"),$(addBookmarkEl).addClass("fa-bookmark-o"))}function toggleBookmark(e){e.stopPropagation();let t=imagesToLoad[currentImageIndex].image,a=getBookmarks();null!=a.find(e=>e==t)?a=a.filter(e=>e!==t):a.push(t),store("bookmarks",JSON.stringify(a)),updateBookmarkOnImageDetailView(t)}function getBookmarks(){let e=localStorage.getItem("bookmarks");try{var t=JSON.parse(e)}catch(e){}return null!=e&&null!=t||(t=JSON.parse("[]")),t}$(function(){$(modalNavCurrentEl).on("keydown",function(e){if("Enter"==event.key){event.preventDefault();let t=Number(modalNavCurrentEl.value);isNumber(t)&&Number.isInteger(t)&&t>0&&t<=imagesToLoad.length&&t-1!=currentImageIndex&&openImgDetailsView(--t),e.target.blur()}})});
